# Частичная реконфигурация Artix-7 через PCI-Express
Данный репозиторий является дополнение к нашей статье в журнале **FPGA-Systems Magazine :: FSM :: № GAMMA (state_2)**.
Проект предназначен для **Vivado 2024.2** и демонстрирует возможности
частичной реконфигурации Artix-7 на devkit'е **Artix-7 AC701 Evaluation Platform (xc7a200tfbg676-2)**.

Проект состоит из двух частей:
- **hardware** -- содержит дизайн для Vivado.
- **software** -- содержит простую программу для взаимодействия с прошивкой.

## Hardware
Прошивка для ПЛИС генерируется обычным способом, проект уже настроен.
Больше деталей в статье.

## Software
### Подготовка
Сначала нужно прошить базовую (полную) прошивку в ПЛИС через JTAG.
Обычно после этого перестает работать PCI-Express у ПЛИС.
Для того, чтобы возобновить соединение нужно либо перезагрузить компьютер, либо выполнить
специальную последовательность команд.
Но сначала нужно сделать:
```
> lspci
c1:00.0 Unassigned class [ff00]: Device 0000:0001
```
На нашем стенде devkit получил ID с1:00.0. В вашей системе он будет отличаться.
Этот ID надо запомнить и использовать в следующей серии команд для обновления PCI-Express устройства (возможно с правами суперпользователя):
```
> setpci -s c1:00.0 COMMAND=0x102
> echo 1 > /sys/bus/pci/devices/0000\:c1\:00.0/remove 
> echo 1 > /sys/bus/pci/devices/0000\:c0\:01.1/rescan 
```

**Обратите внимание, что в последней команде используется ID *ПРЕДЫДУЩЕГО* устройства!**

### Реконфигурация
Для того, чтобы прошить реконфигурируемый модуль в ПЛИС через PCI-Express следуйте инструкции ниже.\
Сначала скомпилируйте утилиту software/dfxdevmem.c:
```
> gcc -o dfxdevmem dfxdevmem.c
```

Эта утилита использует /dev/mem для записи данных в нужные BAR'ы нашего устройства (и чтения версии прошивки).
Для ее корректной работы нужны правильные адреса BAR'ов. Эти адреса можно узнать с помощью **lspci -v**:
```
> lspci -v
c1:00.0 Unassigned class [ff00]: Device 0000:0001
        Flags: fast devsel, IOMMU group 10
        Memory at c4200000 (32-bit, non-prefetchable) [size=1M]
        Memory at 18020f00000 (64-bit, prefetchable) [size=1M]
        Capabilities: <access denied>
```
У нашего устройства 2 BAR'а,  которые имеют следующие адреса **в этой системе**: 
- **BAR 0** получил адрес **c4200000**. Этот адрес нужно указывать при частичной прошивке.
- **BAR 1** получил адрес **18020f00000**. Этот адрес используется для чтения версии прошивки (чтобы убедиться, что частичная конфигурация отработала корректно).
 
 ***В вашей системе адреса будут отличаться!***

Чтобы прошить устройство реконфигурируемым модулем запустите нашу программу следующим образом (но со своим адресом **BAR0** и **местоположением файла прошивки**):
```
> dfxdevmem -b 0xc4200000 -f dummy_axis_dummy_axis_dummy_wrapper_b_partial.bin
```

Чтобы прочитать версию, укажите адрес **BAR1** без указания файла:
```
> dfxdevmem -b 0x18020f00000
```
Для запуска нашей утилиты вам нужны права доступа к файлу **/dev/mem** или права суперпользователя.

VHDL and C source code of this project is licensed under the MIT License. See the [LICENSE](./LICENSE) file for details.\
Copyright (c) 2024 Адамович Игорь Алексеевич